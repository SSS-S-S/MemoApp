<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MemoCurve - 極簡雲端版</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">

    <!-- Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans TC', 'sans-serif'],
                    },
                    colors: {
                        gray: {
                            50: '#f9fafb',
                            100: '#f3f4f6',
                            200: '#e5e7eb',
                            300: '#d1d5db',
                            400: '#9ca3af',
                            500: '#6b7280',
                            600: '#4b5563',
                            700: '#374151',
                            800: '#1f2937',
                            900: '#111827',
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background-color: #ffffff;
            color: #111827;
            -webkit-font-smoothing: antialiased;
        }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .hidden-view { display: none !important; }

        /* Minimalist Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #d1d5db; }

        /* Input specific styles for quiz */
        .quiz-input {
            background: transparent;
            border-bottom: 2px solid #e5e7eb;
            text-align: center;
            font-family: 'Inter', monospace;
            transition: all 0.3s;
        }
        .quiz-input:focus {
            outline: none;
            border-color: #111827;
        }
        .quiz-input.correct {
            border-color: #10b981;
            color: #10b981;
        }
        .quiz-input.wrong {
            border-color: #ef4444;
            color: #ef4444;
        }

        /* Checkbox Custom Style */
        .custom-checkbox:checked {
            background-color: #111827;
            border-color: #111827;
        }
    </style>
</head>
<body class="flex flex-col h-screen overflow-hidden bg-white">

    <!-- Login View (Shown by default, covers everything) -->
    <div id="login-view" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center p-6 text-center">
        <div class="mb-12 animate-pulse-slow">
            <h1 class="text-5xl font-light tracking-tight text-gray-900 mb-2">MemoCurve</h1>
            <p class="text-gray-400 font-mono text-xs tracking-[0.2em] uppercase">Minimalist Repetition</p>
        </div>
        
        <div class="space-y-4 w-full max-w-xs">
            <button id="btn-login-google" class="w-full flex items-center justify-center gap-3 bg-gray-900 text-white px-6 py-4 rounded-xl hover:bg-black transition-all shadow-xl shadow-gray-200 hover:shadow-2xl hover:-translate-y-0.5 transform duration-200">
                <i class="ph-fill ph-google-logo text-xl"></i>
                <span class="font-medium text-sm">Sign in with Google</span>
            </button>
            <p class="text-xs text-gray-300 mt-6">Secure cloud sync powered by Firebase</p>
        </div>
    </div>

    <!-- App View (Hidden until logged in) -->
    <div id="app-view" class="hidden flex flex-col h-full w-full">
        
        <!-- Header -->
        <header class="flex-none pt-8 pb-4 px-6 max-w-2xl mx-auto w-full flex justify-between items-end border-b border-gray-100">
            <div>
                <h1 class="text-3xl font-light tracking-tight text-gray-900">MemoCurve</h1>
                <div id="user-info" class="flex items-center gap-2 mt-1 group cursor-pointer" onclick="window.authManager && window.authManager.logout()">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div>
                    <p id="user-name-display" class="text-xs text-gray-400 font-mono tracking-wide group-hover:text-gray-900 transition-colors">
                        Loading...
                    </p>
                    <i class="ph ph-sign-out text-gray-300 text-xs opacity-0 group-hover:opacity-100 transition-opacity ml-1"></i>
                </div>
            </div>
            <button id="btn-open-add" class="group flex items-center gap-2 text-sm font-medium text-gray-900 hover:text-gray-600 transition-colors">
                <i class="ph ph-plus text-lg"></i>
                <span>Add</span>
            </button>
        </header>

        <!-- Navigation Tabs -->
        <nav class="flex-none max-w-2xl mx-auto w-full px-6 mt-6">
            <div class="flex gap-8 border-b border-gray-100">
                <button onclick="ui.switchTab('review')" id="tab-review" class="pb-3 text-sm font-medium transition-all relative">
                    Review
                    <span class="active-indicator absolute bottom-0 left-0 w-full h-[1px] bg-black hidden"></span>
                </button>
                <button onclick="ui.switchTab('folders')" id="tab-folders" class="pb-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition-all relative">
                    Folders
                    <span class="active-indicator absolute bottom-0 left-0 w-full h-[1px] bg-black hidden"></span>
                </button>
                <button onclick="ui.switchTab('list')" id="tab-list" class="pb-3 text-sm font-medium text-gray-400 hover:text-gray-600 transition-all relative">
                    List & Settings
                    <span class="active-indicator absolute bottom-0 left-0 w-full h-[1px] bg-black hidden"></span>
                </button>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="flex-1 overflow-hidden relative max-w-2xl mx-auto w-full">
            
            <!-- View: Review (Quiz Mode) -->
            <div id="view-review" class="view-section h-full flex flex-col p-6 relative">
                
                <!-- Folder Filter Toggle -->
                <div class="absolute top-4 left-6 z-10">
                    <button onclick="ui.toggleFilterModal()" class="flex items-center gap-2 text-xs font-bold text-gray-400 hover:text-gray-900 uppercase tracking-widest transition-colors">
                        <i class="ph ph-faders"></i> Filter
                    </button>
                </div>

                <div id="review-container" class="flex-1 flex flex-col justify-center items-center text-center overflow-y-auto">
                    <!-- Dynamic Content -->
                </div>
            </div>

            <!-- View: Folders -->
            <div id="view-folders" class="view-section hidden-view h-full flex flex-col p-6 overflow-y-auto">
                <div class="mb-6 flex gap-2">
                    <input type="text" id="new-folder-name" placeholder="New Folder Name..." class="flex-1 border-b border-gray-200 py-2 focus:outline-none focus:border-gray-900 text-sm">
                    <button id="btn-create-folder" class="text-sm font-medium text-gray-900 hover:bg-gray-50 px-4 py-2 rounded transition-colors">Create</button>
                </div>
                <div id="folders-list-container" class="space-y-1">
                    <!-- Folder Items -->
                </div>
            </div>

            <!-- View: List & Settings -->
            <div id="view-list" class="view-section hidden-view h-full flex flex-col p-6 overflow-y-auto">
                
                <!-- Settings / IO -->
                <div class="mb-8 p-4 bg-gray-50 rounded-lg flex flex-wrap gap-4 items-center justify-between">
                    <span class="text-xs font-bold text-gray-400 uppercase tracking-widest">Data Management</span>
                    <div class="flex gap-3">
                        <button onclick="io.exportData()" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded text-xs font-medium hover:border-gray-900 transition-colors">
                            <i class="ph ph-download-simple"></i> Export
                        </button>
                        <label class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-200 rounded text-xs font-medium hover:border-gray-900 transition-colors cursor-pointer">
                            <i class="ph ph-upload-simple"></i> Import JSON
                            <input type="file" id="import-file" class="hidden" onchange="io.importData(this)">
                        </label>
                    </div>
                </div>

                <div class="mb-4 flex items-center justify-between">
                    <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wide">All Words</h3>
                    <span id="total-words-count" class="text-xs text-gray-400 font-mono">0</span>
                </div>

                <div id="word-list-container" class="space-y-0 divide-y divide-gray-100 pb-20">
                    <!-- List Items -->
                </div>
                <div id="empty-list-msg" class="hidden text-center text-gray-400 py-20 font-light">
                    No words added yet.
                </div>
            </div>

        </main>
    </div>

    <!-- Add Word Modal -->
    <div id="add-modal" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg p-8 border border-gray-100 shadow-2xl shadow-gray-200/50 rounded-xl relative">
            <button id="btn-close-add" class="absolute top-6 right-6 text-gray-400 hover:text-gray-900 transition-colors">
                <i class="ph ph-x text-xl"></i>
            </button>
            
            <h2 class="text-xl font-light mb-6 text-gray-900">New Entry</h2>
            
            <div class="space-y-6">
                <!-- Folder Select -->
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Folder</label>
                    <select id="new-word-folder" class="w-full text-base border-b border-gray-200 py-2 bg-transparent focus:outline-none focus:border-gray-900 transition-colors">
                        <!-- Options populated dynamically -->
                    </select>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Front (Target Word)</label>
                    <input type="text" id="new-word-front" class="w-full text-lg border-b border-gray-200 py-2 focus:outline-none focus:border-gray-900 transition-colors placeholder-gray-300" placeholder="e.g., Ephemeral">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Back (Definition)</label>
                    <input type="text" id="new-word-back" class="w-full text-lg border-b border-gray-200 py-2 focus:outline-none focus:border-gray-900 transition-colors placeholder-gray-300" placeholder="Short-lived">
                </div>
                
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Context Sentence</label>
                    <textarea id="new-word-sentences" rows="2" class="w-full text-base border-b border-gray-200 py-2 focus:outline-none focus:border-gray-900 transition-colors resize-none placeholder-gray-300" placeholder="[Ephemeral] beauty."></textarea>
                    <p class="text-[10px] text-gray-400 mt-1">Use brackets [word] to hide word in Review.</p>
                </div>
                
                <div class="pt-4 flex justify-end">
                    <button id="btn-save-word" class="bg-gray-900 text-white px-8 py-3 text-sm font-medium hover:bg-black transition-colors rounded-lg w-full sm:w-auto">
                        Save Entry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Modal (For Review) -->
    <div id="filter-modal" class="fixed inset-0 bg-black/10 backdrop-blur-sm z-40 hidden flex items-start justify-center pt-24 p-4">
        <div class="bg-white w-full max-w-sm p-6 border border-gray-100 shadow-xl rounded-lg relative">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-sm font-bold text-gray-900 uppercase tracking-wide">Review Filters</h3>
                <button onclick="ui.toggleFilterModal()" class="text-gray-400 hover:text-gray-900"><i class="ph ph-x text-lg"></i></button>
            </div>
            <div id="filter-list" class="max-h-60 overflow-y-auto space-y-2 mb-4">
                <!-- Checkboxes populated here -->
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="ui.selectAllFilters(false)" class="text-xs text-gray-400 hover:text-gray-900 px-3 py-2">Clear</button>
                <button onclick="ui.selectAllFilters(true)" class="text-xs text-gray-400 hover:text-gray-900 px-3 py-2">All</button>
                <button onclick="ui.applyFilters()" class="bg-gray-900 text-white text-xs font-medium px-4 py-2 rounded hover:bg-black">Apply</button>
            </div>
        </div>
    </div>

    <!-- Firebase Logic (Module) -->
    <script type="module">
        /* =====================================================
           Firebase Import
        ===================================================== */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import {
          getAuth,
          signInAnonymously,
          onAuthStateChanged,
          GoogleAuthProvider,
          signInWithPopup,
          signOut
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import {
          getFirestore,
          collection,
          addDoc,
          getDocs,
          doc,
          deleteDoc,
          updateDoc,
          query,
          writeBatch,
          onSnapshot
        } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        /* =====================================================
           Firebase Config
        ===================================================== */
        const firebaseConfig = {
          apiKey: "AIzaSyD2CVKzNBn1W2VmSVkBhVKL_c7q3Kq9_28",
          authDomain: "eff-flashcards-app.firebaseapp.com",
          projectId: "eff-flashcards-app",
          storageBucket: "eff-flashcards-app.firebasestorage.app",
          messagingSenderId: "948003752482",
          appId: "1:948003752482:web:d86846487661cb31be587b"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        
        /* =====================================================
           LocalStorage Layer
        ===================================================== */
        const LS_KEYS = {
          folders: "memocurve_folders",
          cards: "memocurve_cards",
          dirty: "memocurve_dirty"
        };
        
        const localDB = {
          load(key, fallback) {
            try {
              const raw = localStorage.getItem(key);
              return raw ? JSON.parse(raw) : fallback;
            } catch {
              return fallback;
            }
          },
          save(key, value) {
            localStorage.setItem(key, JSON.stringify(value));
          }
        };
        
        /* =====================================================
           Global State
        ===================================================== */
        window.state = {
          user: null,
          folders: [],
          cards: [],
          dirty: { folders: {}, cards: {} },
          activeTab: "review",
          currentReviewCard: null,
          selectedFolderIds: new Set()
        };
        
        /* =====================================================
           Load Local Cache First
        ===================================================== */
        function loadLocalState() {
          window.state.folders = localDB.load(LS_KEYS.folders, []);
          window.state.cards = localDB.load(LS_KEYS.cards, []);
          window.state.dirty = localDB.load(LS_KEYS.dirty, { folders: {}, cards: {} });
        }
        
        /* =====================================================
           Auth Manager
        ===================================================== */
        window.authManager = {
          signInGoogle: async () => {
            await signInWithPopup(auth, googleProvider);
          },
          logout: async () => {
            await signOut(auth);
          }
        };
        
        /* =====================================================
           Firebase Auth
        ===================================================== */
        onAuthStateChanged(auth, async (user) => {
          if (!user) {
            await signInAnonymously(auth);
            return;
          }

          document.getElementById('login-view').classList.add('hidden');
          document.getElementById('app-view').classList.remove('hidden');
        
          window.state.user = user;
          loadLocalState();
        
          ui.renderFolderList();
          ui.renderFolderSelect();
          ui.renderWordList();
          ui.renderReview();
        
          setupRealtimeSync(user.uid);
        });
        
        /* =====================================================
           Firebase Snapshot (Sync Only)
        ===================================================== */
        function setupRealtimeSync(uid) {
          const base = `artifacts/memocurve_v2/users/${uid}`;
        
          onSnapshot(query(collection(db, `${base}/folders`)), snap => {
            const folders = [];
            snap.forEach(d => folders.push({ id: d.id, ...d.data() }));
            window.state.folders = folders;
            localDB.save(LS_KEYS.folders, folders);
            ui.renderFolderList();
            ui.renderFolderSelect();
          });
        
          onSnapshot(query(collection(db, `${base}/cards`)), snap => {
            const cards = [];
            snap.forEach(d => cards.push({ id: d.id, ...d.data() }));
            window.state.cards = cards;
            localDB.save(LS_KEYS.cards, cards);
            ui.renderWordList();
            ui.renderReview();
          });
        }
        
        /* =====================================================
           Dirty Marker
        ===================================================== */
        function markDirty(type, id, data) {
          window.state.dirty[type][id] = data;
          localDB.save(LS_KEYS.dirty, window.state.dirty);
        }
        
        /* =====================================================
           Data Manager (Local-first)
        ===================================================== */
        window.dataManager = {
          addFolder: async () => {
            const name = newFolderName.value.trim();
            if (!name) return;
            const id = crypto.randomUUID();
            const folder = { id, name, createdAt: Date.now() };
        
            window.state.folders.push(folder);
            localDB.save(LS_KEYS.folders, window.state.folders);
            markDirty("folders", id, folder);
            ui.renderFolderList();
          },
        
          updateFolder: (id, name) => {
            const f = window.state.folders.find(f => f.id === id);
            if (!f) return;
            f.name = name;
            localDB.save(LS_KEYS.folders, window.state.folders);
            markDirty("folders", id, f);
          },
        
          deleteFolder: (id) => {
            window.state.folders = window.state.folders.filter(f => f.id !== id);
            window.state.cards = window.state.cards.filter(c => c.folderId !== id);
            localDB.save(LS_KEYS.folders, window.state.folders);
            localDB.save(LS_KEYS.cards, window.state.cards);
            markDirty("folders", id, null);
            ui.renderFolderList();
            ui.renderWordList();
          },
        
          addWord: () => {
            const front = newWordFront.value.trim();
            if (!front) return;
            const card = {
              id: crypto.randomUUID(),
              front,
              back: newWordBack.value.trim(),
              sentence: newWordSentences.value.trim(),
              folderId: newWordFolder.value,
              interval: 0,
              repetition: 0,
              ef: 2.5,
              nextReview: Date.now(),
              createdAt: Date.now()
            };
        
            window.state.cards.push(card);
            localDB.save(LS_KEYS.cards, window.state.cards);
            markDirty("cards", card.id, card);
            ui.closeAddModal();
            ui.renderReview();
          },
        
          deleteWord: (id) => {
            window.state.cards = window.state.cards.filter(c => c.id !== id);
            localDB.save(LS_KEYS.cards, window.state.cards);
            markDirty("cards", id, null);
            ui.renderWordList();
          },
        
          gradeWord: (q) => {
            const c = window.state.currentReviewCard;
            if (!c) return;
        
            let { interval, repetition, ef } = c;
            if (q >= 3) {
              interval = repetition === 0 ? 1 : repetition === 1 ? 6 : Math.round(interval * ef);
              repetition++;
              ef += 0.1 - (5 - q) * (0.08 + (5 - q) * 0.02);
            } else {
              repetition = 0;
              interval = 1;
            }
            ef = Math.max(1.3, ef);
        
            Object.assign(c, {
              interval,
              repetition,
              ef,
              nextReview: Date.now() + interval * 86400000
            });
        
            localDB.save(LS_KEYS.cards, window.state.cards);
            markDirty("cards", c.id, c);
            ui.renderReview();
          }
        };
        
        /* =====================================================
           Firebase Background Sync (15s)
        ===================================================== */
        setInterval(async () => {
          if (!window.state.user) return;
          const base = `artifacts/memocurve_v2/users/${window.state.user.uid}`;
          const batch = writeBatch(db);
        
          for (const [id, data] of Object.entries(window.state.dirty.cards)) {
            const ref = doc(db, `${base}/cards`, id);
            data === null ? batch.delete(ref) : batch.set(ref, data);
          }
          for (const [id, data] of Object.entries(window.state.dirty.folders)) {
            const ref = doc(db, `${base}/folders`, id);
            data === null ? batch.delete(ref) : batch.set(ref, data);
          }
        
          await batch.commit();
          window.state.dirty = { folders: {}, cards: {} };
          localDB.save(LS_KEYS.dirty, window.state.dirty);
        }, 15000);

        // --- UI Manager ---
        window.ui = {
            switchTab: (tabId) => {
                const tabs = ['review', 'list', 'folders'];
                
                tabs.forEach(t => {
                    const btn = document.getElementById(`tab-${t}`);
                    const indicator = btn.querySelector('.active-indicator');
                    if (t === tabId) {
                        btn.classList.replace('text-gray-400', 'text-gray-900');
                        indicator.classList.remove('hidden');
                    } else {
                        btn.classList.replace('text-gray-900', 'text-gray-400');
                        indicator.classList.add('hidden');
                    }
                });

                document.querySelectorAll('.view-section').forEach(el => {
                    if (el.id === `view-${tabId}`) {
                        el.classList.remove('hidden-view');
                        el.style.display = 'flex'; 
                        el.classList.add('fade-in');
                    } else {
                        el.classList.add('hidden-view');
                        el.style.display = 'none';
                        el.classList.remove('fade-in');
                    }
                });
                
                window.state.activeTab = tabId;
                
                if (tabId === 'review') ui.renderReview();
                if (tabId === 'list') ui.renderWordList();
                if (tabId === 'folders') ui.renderFolderList();
            },

            renderFolderSelect: () => {
                const sel = document.getElementById('new-word-folder');
                if(!sel) return;
                sel.innerHTML = window.state.folders.map(f => 
                    `<option value="${f.id}">${f.name}</option>`
                ).join('');
            },

            renderFolderList: () => {
                const container = document.getElementById('folders-list-container');
                if(!container) return;
                
                if (window.state.folders.length === 0) {
                     container.innerHTML = '<div class="text-center text-gray-400 py-10">No folders. Create one above.</div>';
                     return;
                }

                container.innerHTML = window.state.folders.map(f => {
                    const count = window.state.cards.filter(c => c.folderId === f.id).length;
                    return `
                    <div class="flex items-center justify-between py-4 border-b border-gray-50 hover:bg-gray-50 px-2 -mx-2 rounded transition-colors group">
                        <div class="flex items-center gap-3 flex-1">
                            <i class="ph ph-folder text-lg text-gray-400"></i>
                            <input type="text" value="${f.name}" 
                                onchange="dataManager.updateFolder('${f.id}', this.value)"
                                onfocus="this.select()"
                                onkeydown="if(event.key === 'Enter') this.blur()"
                                class="bg-transparent focus:bg-white border-b border-transparent focus:border-gray-300 focus:outline-none text-sm text-gray-900 font-medium w-full transition-colors"
                                placeholder="Rename folder...">
                            <i class="ph ph-pencil-simple text-gray-200 text-xs opacity-0 group-hover:opacity-100"></i>
                        </div>
                        <div class="flex items-center gap-4 pl-4">
                            <span class="text-xs text-gray-400 font-mono">${count}</span>
                            <button onclick="dataManager.deleteFolder('${f.id}')" class="text-gray-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                <i class="ph ph-trash"></i>
                            </button>
                        </div>
                    </div>`;
                }).join('');
            },

            renderReview: () => {
                const container = document.getElementById('review-container');
                
                let pool = window.state.cards;
                // Apply Folder Filter
                if (window.state.selectedFolderIds.size > 0) {
                    pool = pool.filter(w => window.state.selectedFolderIds.has(w.folderId));
                }

                if (pool.length === 0) {
                    container.innerHTML = `
                        <div class="flex flex-col items-center justify-center h-full">
                            <i class="ph ph-cards text-4xl text-gray-200 mb-4"></i>
                            <h3 class="text-xl font-light text-gray-900">No Cards</h3>
                            <p class="text-gray-400 mt-2 font-light text-xs">Add cards or check filters</p>
                        </div>
                    `;
                    window.state.currentReviewCard = null;
                    return;
                }

                // Infinite Mode Logic
                const now = Date.now();
                let candidates = pool.filter(w => w.nextReview <= now);
                let isPracticeMode = false;

                if (candidates.length === 0) {
                    candidates = pool; 
                    isPracticeMode = true;
                }

                const word = candidates[Math.floor(Math.random() * candidates.length)];
                window.state.currentReviewCard = word;
                const folderName = window.state.folders.find(f => f.id === word.folderId)?.name || 'Unknown';

                let displaySentence = '';
                if (word.sentence) {
                    displaySentence = word.sentence.replace(/\[.*?\]/g, '______');
                }

                const statusLabel = isPracticeMode ? 'PRACTICE (INFINITE)' : 'DUE FOR REVIEW';

                container.innerHTML = `
                    <div class="w-full max-w-lg mx-auto flex flex-col items-center fade-in pb-10">
                        <div class="w-full mb-8">
                             <div class="flex justify-between items-center mb-10">
                                <span class="text-[10px] font-mono text-gray-400 uppercase tracking-widest">${statusLabel}</span>
                                <span class="text-[10px] font-mono text-gray-400 px-2 py-1 bg-gray-50 rounded">${folderName}</span>
                            </div>

                            <h2 class="text-2xl font-medium text-gray-900 mb-6 leading-snug">${word.back}</h2>
                            
                            ${displaySentence ? `
                                <div class="text-lg text-gray-500 font-light mb-12 italic leading-relaxed">"${displaySentence}"</div>
                            ` : ''}

                            <div id="quiz-area" class="w-full relative max-w-xs mx-auto">
                                <input type="text" id="answer-input" autocomplete="off" spellcheck="false"
                                    class="quiz-input w-full text-3xl py-2 text-gray-900" 
                                    placeholder="Type answer..." 
                                    onkeydown="if(event.key === 'Enter') ui.checkAnswer(this.value)">
                                <p class="text-xs text-gray-300 mt-4">Press Enter to check</p>
                            </div>
                        </div>

                        <div id="result-area" class="hidden w-full mt-auto pt-6 border-t border-gray-100 text-center animate-pulse-once">
                            <div id="correct-answer-display" class="text-3xl font-light text-gray-900 mb-8"></div>
                            
                            <div class="grid grid-cols-2 gap-4 max-w-xs mx-auto">
                                <button onclick="dataManager.gradeWord(1)" class="py-3 rounded bg-red-50 text-red-600 text-xs font-bold hover:bg-red-100 transition-colors">
                                    FORGOT (Again)
                                </button>
                                <button onclick="dataManager.gradeWord(4)" class="py-3 rounded bg-green-50 text-green-600 text-xs font-bold hover:bg-green-100 transition-colors">
                                    GOT IT (Good)
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                setTimeout(() => {
                    const inp = document.getElementById('answer-input');
                    if(inp) inp.focus();
                }, 100);
            },

            checkAnswer: (inputVal) => {
                const card = window.state.currentReviewCard;
                if(!card) return;

                const inputNormal = inputVal.trim().toLowerCase();
                const targetNormal = card.front.trim().toLowerCase();
                const isCorrect = inputNormal === targetNormal;

                const inputEl = document.getElementById('answer-input');
                const resultArea = document.getElementById('result-area');
                const quizArea = document.getElementById('quiz-area');
                const answerDisplay = document.getElementById('correct-answer-display');

                inputEl.disabled = true;
                if (isCorrect) {
                    inputEl.classList.add('correct');
                    answerDisplay.innerHTML = `<span class="text-green-600 flex items-center justify-center gap-2"><i class="ph ph-check-circle"></i> ${card.front}</span>`;
                } else {
                    inputEl.classList.add('wrong');
                    inputEl.value = inputVal; 
                    answerDisplay.innerHTML = `
                        <div class="flex flex-col gap-1">
                            <span class="text-red-500 line-through text-lg opacity-50">${inputVal || 'Empty'}</span>
                            <span class="text-gray-900 font-medium">${card.front}</span>
                        </div>`;
                }

                quizArea.classList.add('opacity-50');
                resultArea.classList.remove('hidden');
                resultArea.classList.add('fade-in');
            },

            renderWordList: () => {
                const container = document.getElementById('word-list-container');
                const countEl = document.getElementById('total-words-count');
                const emptyMsg = document.getElementById('empty-list-msg');
                
                if(!container) return;
                
                if (window.state.cards.length === 0) {
                    container.innerHTML = '';
                    emptyMsg.classList.remove('hidden');
                    countEl.innerText = '0';
                    return;
                }
                
                emptyMsg.classList.add('hidden');
                countEl.innerText = window.state.cards.length;

                const sortedCards = [...window.state.cards].sort((a,b) => b.createdAt - a.createdAt);

                container.innerHTML = sortedCards.map(word => {
                    const folder = window.state.folders.find(f => f.id === word.folderId)?.name || 'Unknown';
                    const previewSentence = word.sentence ? `<div class="text-xs text-gray-400 mt-1 italic">"${word.sentence}"</div>` : '';
                    
                    return `
                    <div class="group flex items-center justify-between py-5 hover:bg-gray-50 transition-colors -mx-4 px-4 rounded-lg">
                        <div class="flex-1 min-w-0 pr-4">
                            <div class="flex items-baseline gap-3">
                                <h3 class="text-base font-medium text-gray-900 truncate">${word.front}</h3>
                                <span class="text-[10px] bg-gray-100 text-gray-500 px-1.5 py-0.5 rounded">${folder}</span>
                            </div>
                            <p class="text-sm text-gray-500 truncate mt-1 font-light">${word.back}</p>
                            ${previewSentence}
                        </div>
                        <button onclick="dataManager.deleteWord('${word.id}')" class="opacity-0 group-hover:opacity-100 text-gray-300 hover:text-red-500 transition-all p-2">
                            <i class="ph ph-trash text-lg"></i>
                        </button>
                    </div>
                `}).join('');
            },

            // --- Modal Helpers ---
            showAddModal: () => {
                document.getElementById('add-modal').classList.remove('hidden');
                ui.renderFolderSelect();
                setTimeout(() => document.getElementById('new-word-front').focus(), 50);
            },
            closeAddModal: () => {
                document.getElementById('add-modal').classList.add('hidden');
                document.getElementById('new-word-front').value = '';
                document.getElementById('new-word-back').value = '';
                document.getElementById('new-word-sentences').value = '';
            },
            toggleFilterModal: () => {
                const modal = document.getElementById('filter-modal');
                modal.classList.toggle('hidden');
                if (!modal.classList.contains('hidden')) ui.renderFilterList();
            },
            renderFilterList: () => {
                const container = document.getElementById('filter-list');
                if(!container) return;
                container.innerHTML = window.state.folders.map(f => `
                    <label class="flex items-center gap-3 cursor-pointer py-2 hover:bg-gray-50 rounded px-2">
                        <input type="checkbox" value="${f.id}" 
                            ${window.state.selectedFolderIds.has(f.id) ? 'checked' : ''}
                            class="custom-checkbox w-4 h-4 rounded border-gray-300 text-black focus:ring-0">
                        <span class="text-sm text-gray-700">${f.name}</span>
                    </label>
                `).join('');
            },
            selectAllFilters: (selectAll) => {
                document.querySelectorAll('#filter-list input[type="checkbox"]').forEach(cb => cb.checked = selectAll);
            },
            applyFilters: () => {
                const cbs = document.querySelectorAll('#filter-list input[type="checkbox"]:checked');
                window.state.selectedFolderIds = new Set(Array.from(cbs).map(cb => cb.value));
                ui.toggleFilterModal();
                ui.renderReview();
            }
        };

        // --- IO (Import/Export) ---
        // Same logic as before
        window.io = {
            exportData: () => {
                const data = window.state.cards.map(c => {
                   // Optional: Export folder name if needed, but current requested format is simple
                   return {
                       front: c.front,
                       back: c.back,
                       sentences: c.sentence ? [c.sentence] : [] 
                   };
                });
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `memocurve_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            },
            importData: async (inputElement) => {
                const file = inputElement.files[0];
                if (!file) return;
                
                if (!window.state.user) return alert("Please login first.");

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const rawData = JSON.parse(e.target.result);
                        if (!Array.isArray(rawData)) throw new Error("Format must be an array.");

                        const userId = window.state.user.uid;
                        const batch = writeBatch(db);
                        
                        let generalFolder = window.state.folders.find(f => f.name === "General");
                        let folderId;
                        
                        if (!generalFolder) {
                             const newFolderRef = doc(collection(db, `artifacts/memocurve_v2/users/${userId}/folders`));
                             batch.set(newFolderRef, { name: "General", createdAt: Date.now() });
                             folderId = newFolderRef.id;
                        } else {
                             folderId = generalFolder.id;
                        }

                        const cardsCollection = collection(db, `artifacts/memocurve_v2/users/${userId}/cards`);
                        
                        rawData.forEach(item => {
                             if (item.front && item.back) {
                                 const newCardRef = doc(cardsCollection);
                                 let sentence = "";
                                 if (Array.isArray(item.sentences) && item.sentences.length > 0) {
                                     sentence = item.sentences[0];
                                 }

                                 batch.set(newCardRef, {
                                     front: item.front,
                                     back: item.back,
                                     sentence: sentence,
                                     folderId: folderId,
                                     interval: 0, repetition: 0, ef: 2.5, nextReview: Date.now(),
                                     createdAt: Date.now()
                                 });
                             }
                        });

                        await batch.commit();
                        alert(`Imported ${rawData.length} cards into "General" folder!`);
                        inputElement.value = '';
                    } catch (err) { console.error(err); alert("Import failed: " + err.message); }
                };
                reader.readAsText(file);
            }
        };

        // --- Event Binding ---
        const bindBtn = (id, handler) => {
            const btn = document.getElementById(id);
            if(btn) btn.addEventListener('click', handler);
        };

        bindBtn('btn-login-google', authManager.signInGoogle);
        bindBtn('btn-create-folder', dataManager.addFolder);
        bindBtn('btn-open-add', ui.showAddModal);
        bindBtn('btn-close-add', ui.closeAddModal);
        bindBtn('btn-save-word', dataManager.addWord);

        // Close modal listener
        document.getElementById('add-modal').addEventListener('click', function(e) {
            if (e.target === this) ui.closeAddModal();
        });

    </script>
</body>
</html>
